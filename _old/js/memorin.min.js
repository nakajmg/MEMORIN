!function(){var a=Backbone.Model.extend({defaults:function(){return{content:"",color:_.random(1,10),tags:[],important:!1}},validate:function(a){return _.isEmpty(a.content)?"content must not be empty":void 0},toggleImportant:function(){this.set("important",!this.get("important"))},toggleTag:function(a){console.log("toggletag:",a);var b=_(this.get("tags")).clone();_.contains(b,a)?b=_.filter(b,function(b){return b!=a}):b.push(a),this.set("tags",b),console.log("tags",b)}}),b=Backbone.View.extend({tagName:"div",className:"memo",template:_.template($("#template-memo").html()),initialize:function(){this.isCmd=!1,this.model.on("change",this.change,this),this.model.on("destroy",this.destroy,this)},events:{"keydown .memo__content":"onUpdate","keyup .memo__content":"checkCmdKey","blur .memo__content":"onBlur","click .memo__remove":"removeMemo","click .memo__flip":"flipMemo","click .memo__backface__important":"toggleImportant","click .js-toggle-tag":"toggleTag"},toggleTag:function(a){var b=$(a.target).attr("name");this.model.toggleTag(b)},toggleImportant:function(){console.log(this),this.model.toggleImportant()},change:function(){console.log("MemoView:changememo")},destroy:function(){var a="webkitAnimationEnd",b=this.$el,c=this;b.one(a,function(){c.$el.remove()}).addClass("anime-memo-remove")},onUpdate:function(a){(91===a.which||93===a.which)&&(this.isCmd=!0),this.isCmd&&13===a.which&&(this.isCmd=!1,console.log("call save"),this.doSave())},onBlur:function(){var a=this.$el.find(".memo__content");a.attr("contenteditable","false"),setTimeout(function(){a.attr("contenteditable","true")},0),this.setContent()},checkCmdKey:function(a){(91===a.which||93===a.which)&&(this.isCmd=!1)},doSave:function(){this.$el.find(".memo__content").blur()},setContent:function(){this.model.set("content",this.$el.find(".memo__content").html())},removeMemo:function(){console.log("削除アニメ開始地点"),this.model.destroy()},flipMemo:function(){this.$el.toggleClass("flip")},render:function(){var a=(this.model,this.template(this.model.toJSON()));return this.$el.html(a),this}}),c=Backbone.Collection.extend({model:a}),d=Backbone.View.extend({tagName:"section",className:"memo-list",initialize:function(){this.collection.on("change",this.onChange,this),this.collection.on("add",this.onAdd,this),this.collection.on("remove",this.onUpdate,this),this.collection.on("update",this.onUpdate,this)},onUpdate:function(){this.saveLocalStorage()},onChange:function(){console.log("MemolistView:onchange"),this.saveLocalStorage()},saveLocalStorage:function(){var a=JSON.stringify(this.collection.toJSON());localStorage.setItem(f,a),console.log("save:localStorage")},onAdd:function(a){this.saveLocalStorage();var c=new b({model:a});this.$el.prepend(c.render().el)},render:function(){return this.collection.each(function(a){var c=new b({model:a});this.$el.prepend(c.render().el)},this),this},renderImportant:function(){var a=this.collection.where({important:!0});return _.each(a,function(a){var c=new b({model:a});this.$el.prepend(c.render().el)},this),this},renderTag:function(a){return this.collection.each(function(c){var d=c.get("tags");if(_.contains(d,a)){var e=new b({model:c});this.$el.prepend(e.render().el)}},this),this}});if(_.isEmpty(localStorage.getItem("memorin"))){var e=Date.now()+"";localStorage.setItem("memorin",e)}{var f="memorin-"+localStorage.getItem("memorin"),g=new c(JSON.parse(localStorage.getItem(f))),h=Backbone.View.extend({el:"#main",initialize:function(){var a=this,b="touchstart mousedown",c="touchend touchemove mousemove mouseup";this.$render=this.$el.find("#render"),this.showAllMemo(),this.$el.find(".show-tag").on("click",function(){a.showTagMemo($(this).val())}),$(document).on(b,".js-button",function(){$(this).addClass("button--on")}),$(document).on(c,".js-button",function(){$(this).removeClass("button--on")}),$("#js-toggle-editor").on("click",function(){var a=$(this);a.hasClass("anime-plus-btn")?(a.removeClass("anime-plus-btn"),$("#editor").slideUp(500)):(a.addClass("anime-plus-btn"),$("#editor").slideDown(500))})},events:{"click #show-all":"showAllMemo","click #show-important":"showImportantMemo"},showAllMemo:function(){var a=new d({collection:this.collection});this.$render.html(a.render().el),console.log("show all memo")},showImportantMemo:function(){var a=new d({collection:this.collection});this.$render.html(a.renderImportant().el),console.log("show important memo")},showTagMemo:function(a){var b=new d({collection:this.collection});this.$render.html(b.renderTag(a).el),console.log("show tag memo")}}),i=Backbone.View.extend({el:"#editor",isCmd:!1,events:{submit:"onSubmit","keydown .memo__editor":"onKeydown","keyup .memo__editor":"onKeyup"},COLOR_COUNT:18,initialize:function(){var a=_.random(1,this.COLOR_COUNT);$("#textarea").addClass("color"+a).attr("data-color",a)},onSubmit:function(b){function c(){f.resetEditor()}b.preventDefault();var d=$("#textarea").html(),e=$("#textarea").attr("data-color");if(_.isEmpty(d))return!1;var f=this,g=new a,h=[];$("#todo").prop("checked")&&h.push($("#todo").attr("id")),$("#other").prop("checked")&&h.push($("#other").attr("id"));var i=$("#important").prop("checked");g.set({content:d,important:i,tags:h,color:e},{validate:!0}),this.keyframesAnimationHelper($("#textarea"),"anime-memo-add").then(function(){console.log("animation end"),$("#textarea").css("visibility","hidden"),$("#textarea").removeClass("anime-memo-add"),c(),setTimeout(function(){$("#textarea").css("visibility","visible"),f.collection.add(g)},100)})},onKeydown:function(a){console.log("keydown"),(91===a.which||93===a.which)&&(this.isCmd=!0),this.isCmd&&13===a.which&&(this.isCmd=!1,this.onSubmit(a),$(a.target).blur())},onKeyup:function(a){(91===a.which||93===a.which)&&(this.isCmd=!1)},resetEditor:function(){var a=_.random(1,this.COLOR_COUNT),b=$("#textarea").attr("data-color");$("#textarea").attr("data-color",a),$("#textarea").html("").removeClass("color"+b).addClass("color"+a),$("#todo").prop("checked",""),$("#other").prop("checked",""),$("#important").prop("checked","")},keyframesAnimationHelper:function(a,b,c){var d=$.Deferred(),e="webkitAnimationEnd";return a.one(e,function(){c&&a.removeClass(b),d.resolve(a)}).addClass(b),d.promise()}});new h({collection:g}),new i({collection:g})}}();